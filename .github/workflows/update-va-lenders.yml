name: Auto-Update VA Lenders

on:
  schedule:
    # Run on the 1st of every month at 3am UTC
    - cron: '0 3 1 * *'
  workflow_dispatch: # Allow manual trigger from GitHub UI

jobs:
  update-lenders:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install openpyxl mysql-connector-python python-dotenv requests

      - name: Download latest VA lender report
        run: |
          # Download the most recent VA lender loan volume Excel file
          YEAR=$(date +%y)
          MONTH=$(date +%B | tr '[:upper:]' '[:lower:]')
          URL="https://www.benefits.va.gov/HOMELOANS/documents/lender-statistics/fy${YEAR}-${MONTH}-lender-loan-volume.xlsx"
          echo "Trying: $URL"
          curl -L -o va_lenders_latest.xlsx "$URL" || \
          curl -L -o va_lenders_latest.xlsx "https://www.benefits.va.gov/HOMELOANS/documents/lender-statistics/fy26-january-lender-loan-volume.xlsx"
          ls -lh va_lenders_latest.xlsx

      - name: Run lender update script
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: python scripts/update-va-lenders.py

      - name: Commit updated lender count to repo
        run: |
          git config --global user.email "auto-update@servicesourceconnect.com"
          git config --global user.name "ServiceSource Auto-Updater"
          git add -A
          git diff --staged --quiet || git commit -m "chore: Auto-update VA lenders from official VA report [$(date +%Y-%m-%d)]"
          git push origin main || true
